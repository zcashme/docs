<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Zcash Me Docs â€” Table of Contents</title>
  <style>
    :root {
      /* defaults to light theme */
      --bg: #f6f8fa;
      --panel: #ffffff;
      --text: #0b0e11;
      --muted: #5a6b82;
      --accent: #0a8f66;
      --border: #e5e7eb;
      --hover: #f1f5f9;
      --hover-sub: #eef2f7;
    }
    [data-theme="dark"] {
      --bg: #0b0e11;
      --panel: #11161c;
      --text: #e6eef8;
      --muted: #9fb0c6;
      --accent: #00c389;
      --border: #1c232c;
      --hover: #1a2027;
      --hover-sub: #182028;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      background: var(--bg);
      color: var(--text);
      font: 14px/1.6 -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji";
    }
    .layout { display: grid; grid-template-columns: 280px 1fr; min-height: 100vh; }
    nav { background: var(--panel); border-right: 1px solid var(--border); padding: 20px 16px; position: sticky; top: 0; height: 100vh; overflow-y: auto; }
    .brand { font-weight: 600; font-size: 16px; margin-bottom: 12px; }
    .subtitle { color: var(--muted); font-size: 12px; margin-bottom: 16px; }
    .toc { list-style: none; padding: 0; margin: 0; }
    .toc > li { margin: 8px 0 6px; }
    .toc-section { color: var(--text); font-weight: 600; text-decoration: none; display: block; padding: 6px 8px; border-radius: 6px; }
    .toc-section:hover { background: var(--hover); }
    .toc-sublist { list-style: none; margin: 6px 0 6px 8px; padding-left: 10px; border-left: 1px solid var(--border); }
    .toc-subitem { color: var(--muted); text-decoration: none; display: block; padding: 4px 8px; border-radius: 6px; }
    .toc-subitem:hover { color: var(--text); background: var(--hover-sub); }
    main { padding: 28px; }
    h1 { margin: 0 0 8px; font-size: 24px; font-weight: 700; }
    .note { color: var(--muted); }
    .footer { margin-top: 24px; color: var(--muted); font-size: 12px; border-top: 1px solid var(--border); padding-top: 16px; }
    .badge { color: var(--accent); font-weight: 600; }
    .theme-toggle { display: flex; gap: 8px; align-items: center; margin-bottom: 16px; }
    .theme-label { font-size: 12px; color: var(--muted); }
    .theme-btn { appearance: none; border: 1px solid var(--border); background: transparent; color: var(--text); padding: 6px 10px; border-radius: 8px; font-size: 12px; cursor: pointer; }
    .theme-btn:hover { background: var(--hover); }
    .theme-btn.active { background: var(--accent); border-color: var(--accent); color: #ffffff; }
    /* Release Notes styles */
    .release { margin-top: 24px; padding-top: 16px; border-top: 1px solid var(--border); }
    .release h2 { margin: 0 0 8px; font-size: 16px; font-weight: 700; }
    .release .note { color: var(--muted); }
    .release ul { list-style: disc; margin: 8px 0 0 16px; padding: 0; }
    .release li { margin: 4px 0; color: var(--text); }
  </style>
</head>
<body>
  <div class="layout" id="app-root">
    <nav>
      <div class="brand">Zcash Me Docs</div>
      <div class="subtitle">Table of Contents (from README.md)</div>
      <div class="theme-toggle" role="group" aria-label="Theme">
        <span class="theme-label">Theme</span>
        <button id="theme-light" class="theme-btn" type="button" aria-pressed="false">Light</button>
        <button id="theme-dark" class="theme-btn" type="button" aria-pressed="false">Dark</button>
      </div>
      <ul id="toc-root" class="toc"></ul>
    </nav>
    <main>
      <h1>Documentation Overview</h1>
      <p class="note">This page generates a table of contents from the repository <code>README.md</code>. Content pages will be added next.</p>
      <section id="release-notes" class="release" aria-labelledby="release-title">
        <h2 id="release-title">Release Notes</h2>
        <div id="release-content" class="note">Latest release notes will be automatically extracted from <code>README.md</code>.</div>
      </section>
      <div class="footer">Powered by <span class="badge">GitHub Pages</span>. Update <code>README.md</code> to change the outline.</div>
    </main>
  </div>
  <script>
    function setTheme(theme) {
      const root = document.documentElement;
      root.setAttribute('data-theme', theme);
      try { localStorage.setItem('theme', theme); } catch (e) {}
      const darkBtn = document.getElementById('theme-dark');
      const lightBtn = document.getElementById('theme-light');
      const isDark = theme === 'dark';
      darkBtn.classList.toggle('active', isDark);
      lightBtn.classList.toggle('active', !isDark);
      darkBtn.setAttribute('aria-pressed', String(isDark));
      lightBtn.setAttribute('aria-pressed', String(!isDark));
    }
    function initTheme() {
      let initial = 'light';
      try {
        const saved = localStorage.getItem('theme');
        if (saved === 'light' || saved === 'dark') initial = saved;
      } catch (e) {}
      setTheme(initial);
      document.getElementById('theme-dark').addEventListener('click', () => setTheme('dark'));
      document.getElementById('theme-light').addEventListener('click', () => setTheme('light'));
    }
    async function fetchReadmeText() {
      const candidates = ['README.md', '../README.md'];
      for (const url of candidates) {
        try {
          const res = await fetch(url, { cache: 'no-store' });
          if (res.ok) return res.text();
        } catch (e) {}
      }
      throw new Error('README.md not found');
    }

    async function buildTOC() {
      const root = document.getElementById('toc-root');
      try {
        // Prefer reading the README from the current directory (copied by the workflow), fallback to the parent directory when running locally.
        const md = await fetchReadmeText();
        const lines = md.split(/\r?\n/);
        let currentSectionUl = null;
        let currentSubsectionUl = null;
        const makeTextId = (t) => t.toLowerCase().replace(/[^a-z0-9\s-]/g,'').trim().replace(/\s+/g,'-');
        for (const raw of lines) {
          const line = raw.replace(/\s+$/,'');
          if (!line || line.startsWith('---')) continue;
          if (/^##\s+/.test(line)) {
            const title = line.replace(/^##\s+/, '').trim();
            const id = makeTextId(title);
            const li = document.createElement('li');
            const a = document.createElement('a');
            a.className = 'toc-section';
            a.textContent = title;
            a.href = `#${id}`;
            li.appendChild(a);
            currentSectionUl = document.createElement('ul');
            currentSectionUl.className = 'toc-sublist';
            li.appendChild(currentSectionUl);
            root.appendChild(li);
            currentSubsectionUl = null;
            continue;
          }
          const m = line.match(/^(\s*)(\d+)\.\s+(.*)$/);
          if (m && currentSectionUl) {
            const indent = m[1].length;
            const text = m[3].trim();
            const id = makeTextId(text);
            if (indent === 0) {
              const li = document.createElement('li');
              const a = document.createElement('a');
              a.className = 'toc-subitem';
              a.textContent = text;
              a.href = `#${id}`;
              li.appendChild(a);
              currentSectionUl.appendChild(li);
              currentSubsectionUl = document.createElement('ul');
              currentSubsectionUl.className = 'toc-sublist';
              li.appendChild(currentSubsectionUl);
            } else {
              if (!currentSubsectionUl) {
                currentSubsectionUl = document.createElement('ul');
                currentSubsectionUl.className = 'toc-sublist';
                currentSectionUl.appendChild(currentSubsectionUl);
              }
              const li = document.createElement('li');
              const a = document.createElement('a');
              a.className = 'toc-subitem';
              a.textContent = text;
              a.href = `#${id}`;
              li.appendChild(a);
              currentSubsectionUl.appendChild(li);
            }
          }
        }
        // Synchronously build Release Notes
        buildReleaseNotes(md);
        // Load latest commit information (optional)
        loadLatestCommit();
      } catch (err) {
        const li = document.createElement('li');
        li.textContent = 'Could not load README.md';
        root.appendChild(li);
        console.error(err);
      }
    }

    function buildReleaseNotes(md) {
      const container = document.getElementById('release-content');
      if (!container) return;
      try {
        const lines = md.split(/\r?\n/);
        const headerRegex = /^##\s+(Release\s*Notes|Changelog|Release\s*Notes)/i;
        let startIdx = -1;
        for (let i = 0; i < lines.length; i++) {
          if (headerRegex.test(lines[i])) { startIdx = i + 1; break; }
        }
        if (startIdx === -1) {
          container.textContent = 'README does not contain Release Notes section.';
          return;
        }
        const section = [];
        for (let i = startIdx; i < lines.length; i++) {
          const line = lines[i];
          if (/^##\s+/.test(line)) break; // Next section starts
          if (/^---\s*$/.test(line)) continue; // Skip horizontal rules
          section.push(line);
        }
        // Simple Markdown list/paragraph rendering
        const ul = document.createElement('ul');
        let hasItems = false;
        for (const raw of section) {
          const s = raw.trim();
          if (!s) continue;
          const bullet = s.match(/^(-|\*|\d+\.)\s+(.*)$/);
          if (bullet) {
            const li = document.createElement('li');
            li.textContent = bullet[2].trim();
            ul.appendChild(li);
            hasItems = true;
          } else {
            const p = document.createElement('p');
            p.className = 'note';
            p.textContent = s;
            container.appendChild(p);
          }
        }
        if (hasItems) container.appendChild(ul);
        if (!container.childNodes.length) {
          container.textContent = 'Release Notes section is empty.';
        }
      } catch (e) {
        container.textContent = 'Error parsing Release Notes.';
        console.error(e);
      }
    }

    async function loadLatestCommit() {
      const container = document.getElementById('release-content');
      if (!container) return;
      try {
        const res = await fetch('commit.json', { cache: 'no-store' });
        if (!res.ok) return; // No commit data, skip
        const data = await res.json();
        const wrap = document.createElement('div');
        wrap.className = 'note';
        const shortSha = (data.sha || '').slice(0, 7);
        const msg = data.message || 'Latest commit';
        const date = data.date ? new Date(data.date).toLocaleString() : '';
        const link = data.url ? `<a href="${data.url}" target="_blank" rel="noopener">${shortSha}</a>` : shortSha;
        wrap.innerHTML = `Latest commit: ${msg} (${link}${date ? ', ' + date : ''})`;
        container.prepend(wrap);
      } catch (e) {
        console.error(e);
      }
    }
    initTheme();
    buildTOC();
  </script>
</body>
</html>